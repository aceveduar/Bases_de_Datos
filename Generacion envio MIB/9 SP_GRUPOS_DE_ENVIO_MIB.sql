 --1ER COMPRABACION
  SELECT NUM_COD, COUNT(*) FROM ALTAS
	 WHERE CONTPER IN ('1H','2H')
  GROUP BY NUM_COD
--EL CAMPO CONMUESTRA ME INDICA EL GPO AL QUE VOY ASOCIAR UN ENCARTE A LA REVISTA
--2 QUERY DE COMPRABACION DE ENCARTES INDICADO EN EL PEDIDO DEL COLASH
SELECT CONMUESTRA, COUNT(*) FROM ALTAS
GROUP BY CONMUESTRA

--OBSERVACIONES: 
--EL CAMPO CONTPER ME DA LA INFORMACION SI ES 1H, 2H O SUS
--EL CAMPO NUM_COD ME DICE CUANTOS ENVIOS LLEVO HECHOS A LA MAMÁ
--SI EL NUM_COD IS NULL SIGNIFICA QUE NO SE HA HECHO ENVIOS A LA MAMÁ
--INICIA PROCESO



CREATE OR REPLACE PROCEDURE SP_GRUPOS_DE_ENVIO_MIB
AS
CURSOR CTO_CUR IS
 SELECT CONCALT
 FROM
 MP_PRMALTASM M,MP_PRMALTASH H
 WHERE CONMAR=HIJMAR
 AND   CONPRM=HIJPRM
 AND   CONCALT=HIJCALT
 --AND (CONEDAD1 IS NOT NULL OR CONEDAD2 IS NOT NULL OR CONEDAD3 IS NOT NULL)
--AND   MONTHS_BETWEEN(SYSDATE,HIJFNA) BETWEEN 12 AND 36     -----
-- AND   CONNIVEL IN ('AB','C','C-')                               -----
-- AND   CONEDO IN ('DF')                                     -----
 AND   CONCALT IN (SELECT CON_ID FROM ALTAS
                   	WHERE CONMUESTRA IS NULL
                   	AND  CONTPER IN ('1H','2H')
                   	--AND NUM_COD IS NULL 
                   ) AND ROWNUM <=5000;

 CTO_REC CTO_CUR%ROWTYPE;

 CENTRO VARCHAR2(100);
 PG     VARCHAR2(20);
 PLAZ   VARCHAR2(4);
BEGIN
OPEN CTO_CUR;
	
  LOOP 
   FETCH CTO_CUR INTO CTO_REC;
    EXIT WHEN CTO_CUR%NOTFOUND;

 BEGIN             
              BEGIN

               UPDATE ALTAS
               SET CONMUESTRA='GPO2'-- SE MODIFICA EL GRUPO
              WHERE CON_ID=CTO_REC.CONCALT 
              AND  CONMUESTRA IS NULL;

             END;     
  END;
		      	
END LOOP;
  CLOSE CTO_CUR;
      COMMIT;                    
END;

