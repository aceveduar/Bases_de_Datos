
--ESTE ACTUALIZA LOS ESTADOS REVISAR LA ABREV. ES CORRECTA------------

CREATE OR REPLACE PROCEDURE SP_ACT_ESTADO
AS

CURSOR DIR_CURSOR IS
SELECT M.CONCALT,M.CODESTADO,M.CONEDO,M.CONCPO
FROM MP_PRMALTASM M,ALTAS A
WHERE M.CONMAR=50
AND   M.CONPRM=1
AND   M.CONCALT=CON_ID
AND   M.CIUDAD IS NOT NULL
AND   M.MUNICIPIO IS NOT NULL
AND   M.CODESTADO IS NOT NULL
AND   M.CONOFCR IS  NOT  NULL
AND   M.CONCPO IS NOT NULL
AND   M.CONCOLO IS NOT NULL
AND   M.ASENTAMIENTO IS NOT NULL;
 DIR_REC DIR_CURSOR%ROWTYPE;
 CANT NUMBER;
 ESTABR VARCHAR2(6);	
    
BEGIN

OPEN DIR_CURSOR;
	
  LOOP 
   FETCH DIR_CURSOR INTO DIR_REC;
    EXIT WHEN DIR_CURSOR%NOTFOUND;

       BEGIN

      SELECT DISTINCT(EST_ABR) INTO ESTABR
         FROM CODIGO_POSTAL
          WHERE CODIGO_POSTAL=DIR_REC.CONCPO;
          
        EXCEPTION WHEN OTHERS THEN

             ESTABR:=NULL;
                 
      END ;
   
      IF ESTABR IS NOT NULL THEN
            
            UPDATE ALTAS
            SET CONEDO=ESTABR
            WHERE CON_ID=DIR_REC.CONCALT;

           UPDATE MP_PRMALTASM
           SET CONEDO=ESTABR
           WHERE CONCALT=DIR_REC.CONCALT;
                    
      END IF;   
		      	
END LOOP;

  CLOSE DIR_CURSOR;

    COMMIT;
	                                
END;
